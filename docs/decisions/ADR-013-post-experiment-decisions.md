# ADR-013: 实验后决策 — 评估框架、多视角策略与压缩方案

**日期**: 2026-02-16
**状态**: 已批准
**关联**: ADR-012 (从研究到执行的转向), EXP-005/006/007, 研究 003

---

## 背景

ADR-012 规划的三组配对实验全部完成：

| 实验 | 假说 | 结果 | 统计显著 |
|------|------|------|---------|
| EXP-005: BGE-M3 vs mpnet | BGE-M3 ≥ mpnet | +5pp, 趋势正确 | 否 |
| EXP-006: BQL vs SimHash | BQL 保留 ≥90% | 62% 保留 | 是（退化） |
| EXP-007: 多视角查询 | L3 +20pp | -30pp | 是（退化） |

两个"失败"实验揭示了比假说本身更重要的发现：

1. **EXP-006**: MRL 512d 截断对短 Intent 文本信息损失过大。文献报告的 93%+ 精度保留率是长文本场景数据，不能直接迁移到 Intent-to-Intent 短文本场景。
2. **EXP-007**: 多视角生成质量很高，但"合并取 top-K"导致稀释。更关键的是：**现有评估框架（expected_hits precision）无法衡量"意外发现"价值**——而这恰恰是通爻响应范式的核心价值主张。

本 ADR 记录基于实验结果做出的三组决策。

---

## 决策 1: 压缩方案 — 保留 SimHash，BQL 存档为未来路径

### 选项分析

| 选项 | 存储/Intent | 精度保留 | 风险 |
|------|------------|---------|------|
| A: 保留 SimHash 10000d | 1250 bytes | 100%（基线） | 无 |
| B: BQL-1024（不截断，直接量化） | 128 bytes | 未测 | 需新一轮实验 |
| C: MRL-768 + BQL | 96 bytes | 未测 | 需新一轮实验 |
| D: BQL-512（已测） | 64 bytes | 62% | 已证明不可接受 |

### 决策：选项 A — 保留 SimHash

**理由**：
1. **当前规模不需要压缩**。447 Agent × 1250 bytes = 545 KB。即使 1 万人也只是 12 MB。服务器容量 50 GB，完全不是瓶颈。
2. **精度是第一优先**。系统还在验证核心价值主张阶段，精度退化的风险不值得承担。
3. **百万级规模的压缩需求是真实的**，但那时每个人的上下文量也会是现在的 100 倍（更丰富的画像、更多的 Intent），需要重新评估压缩策略。现在做的决策到那时可能已经过时。
4. BQL 代码（MrlBqlProjector）已实现并通过测试，**存档不删除**。将来需要时直接拿出来，不需要从零开始。

### 存档标注

MrlBqlProjector 在 `backend/towow/field/projector.py` 中保留，`__init__.py` 中保留导出。不在生产 pipeline 中使用，但可被实验代码和未来版本引用。

---

## 决策 2: 多视角策略 — 分层呈现 + 全量启用

### 选项分析

**呈现方式**：
| 选项 | 描述 | 优势 | 劣势 |
|------|------|------|------|
| A: 合并排序 | 4 个方向混在一起取 top-K | 简单 | **已被 EXP-007 证伪**——稀释问题 |
| B: 加权合并 | 原始查询 2x 权重 | 缓解稀释 | 仍丢失"为什么推荐"的信息 |
| C: 分层呈现 | 共振/互补/干涉分区展示 | 保留信息，用户知道为什么 | UI 设计需要更多思考 |

**启用策略**：
| 选项 | 描述 | 优势 | 劣势 |
|------|------|------|------|
| X: 全量启用 | 每次查询都跑多视角 | 体验完整一致 | LLM 调用成本 |
| Y: 条件启用 | 单查询命中率低时才启用 | 省钱 | 体验不一致 |

### 决策：选项 C + X — 分层呈现 + 全量启用

**分层呈现理由**：
- 通爻的核心卖点是"发现你不知道自己需要的人"。分层呈现直接把这个价值可视化：用户看到"共振匹配 5 人"是预期内的，"互补发现 3 人"和"意外关联 2 人"是惊喜
- 合并排序把"为什么推荐这个人"的信息丢掉了——这是产品最有价值的信息
- Netflix 不把所有内容按评分排一个列表，而是分"为你推荐"/"因为你看了 X"/"隐藏佳作"——同样的道理

**全量启用理由**：
- "发现意外关联"是核心价值主张，不是可选功能。只在部分情况下展示会削弱这个定位
- 当前阶段 LLM 成本由平台承担（~$0.01/次），可接受
- 分布式架构下（V2+），算力成本由用户端承担，用户可以自己选择是否启用多视角——但默认应该是开启的

### 影响

- 前端呈现层需要支持分区展示（不影响后端 Protocol）
- `MultiPerspectiveResult` 的 3 个视角标签（resonance/complement/interference）直接映射到 UI 分区
- Field API 的 match_owners 返回结构可能需要扩展，增加 `perspective` 标签

---

## 决策 3: 评估框架 — LLM-as-Judge 为主，结构性指标为辅

### 问题本质

现有评估方法（expected_hits precision@K）是**搜索范式的指标**：
- 预定义一组"正确答案"
- 衡量 top-K 里命中了多少

通爻是**响应范式**——核心价值在"发现用户不知道自己需要的人"。这些人不在预定义的"正确答案"里。

**用搜索范式的指标评估响应范式的系统，注定低估系统的真实价值。**

EXP-007 的"-30pp"可能不是系统变差了，而是系统找到了一类我们的评估方法看不见的价值。

### 选项分析

| 选项 | 能衡量意外发现？ | 成本 | 可行性 |
|------|----------------|------|--------|
| A: LLM-as-Judge | 是 | ~$4/次完整评估 | 高，立即可做 |
| B: 人工全量标注 | 是 | 8940 次标注 | 低，工作量太大 |
| C: 结构性指标（多样性/意外度） | 间接 | 零 | 高，全自动 |
| D: 真实用户 A/B 测试 | 是（ground truth） | 需要规模 | 当前不可行 |

### 决策：A + C — LLM-as-Judge 为主评估，结构性指标为辅

**LLM-as-Judge 设计要点**：
- 为裁判设计专门的人设和底层逻辑（不是简单地问"相关吗"）
- 裁判需要理解通爻的价值主张：不只是"这个人能不能做这件事"，还包括"这个人能带来什么意外价值"
- 评分维度应该分层：直接相关性（1-5）+ 互补价值（1-5）+ 意外发现价值（1-5）
- 评分结果可以直接用于对比单查询 vs 多视角：**不是比"命中了几个已知答案"，而是比"找到的人总价值有多高"**

**结构性指标**：
- **多样性**: Top-K 覆盖几个不同技能领域
- **意外度**: Top-K 中与查询关键词不直接重叠的人数
- **覆盖度**: 查询的隐含子需求被 Top-K 覆盖的比例

这两套指标配合使用：LLM-as-Judge 给出质量判断，结构性指标给出分布特征。

### 这个决策的深层意义

> "评估框架本身需要与系统范式对齐"——这不只是一个工程问题，是一个**认识论**问题。
>
> 如果我们发现确实如此（多视角找到的人被 LLM 裁判评为高价值，但被 precision@K 评为 miss），那这个发现本身就是**论文级别的贡献**：
>
> **搜索范式的评估指标系统性地低估了响应范式系统的价值。需要新的评估范式。**

---

## 原则对齐

| 原则 | 对齐方式 |
|------|---------|
| §0.2 协议层不可改，基础设施层可替换 | SimHash/BQL 都是基础设施层，保留/替换都不影响协议 |
| §0.5 代码保障 > Prompt 保障 | LLM-as-Judge 的评分用代码聚合分析，不凭直觉判断 |
| §0.6 需求 ≠ 要求 | 分层呈现体现了这个原则——互补和干涉匹配回应的是需求背后的深层张力 |
| §0.8 投影是基本操作 | 多视角 = 同一需求通过不同透镜的投影，每个投影是一次聚焦 |

---

## 执行顺序

```
① 实现 LLM-as-Judge 评估器                — 新 Skill 或扩展 towow-lab
② 用新评估器重新评估 EXP-007 数据         — 验证多视角的真实价值
③ 基于 ② 的结果，调整多视角呈现策略       — 确定分层比例和权重
④ Field 体验页 + 分层呈现 UI              — 让用户能看到和体验
```

---

## 影响范围

| 影响 | 说明 |
|------|------|
| 新增评估器 | `tests/field_poc/` 下新增 LLM-as-Judge 评估脚本 |
| 多视角 Prompt | `multi_perspective.py` 保持不变，前端消费方式改变 |
| Field API | match_owners 返回可能扩展 perspective 字段 |
| 前端 | 分层呈现 UI（与 Field 体验页一起做） |
| SimHash | 保留不动 |
| MrlBqlProjector | 存档在代码中，不上线 |
