# ADR-014: 模块二（结晶协议）实现决策

**日期**: 2026-02-18
**状态**: 已批准
**关联**: ADR-011 (V2 Intent Field), ADR-013 (实验后决策), DESIGN_LOG_006 (结晶协议设计)

## 背景

模块二设计文档已完成（DESIGN_LOG_006 自包含版）。本 ADR 记录从设计到实现之间的接口级和应用层决策。

设计文档定义了协议层：两种角色（端侧 Agent + 催化 Agent）、循环机制、收敛条件、催化约束。本 ADR 定义实现层：接口、触发、规模、交付、实验策略。

## 决策

### 决策 1：模块一→模块二接口

**选择**: 三视角并集 top-K 作为参与者列表。

模块一当前输出三条排序列表（共振/互补/干涉视角），不是邻近图。初始版本取三个视角的并集 top-K 作为结晶参与者。

**干涉视角权重不低于其他两个**。干涉意味着"意外关联"，这类参与者在结晶中最可能产生跨语义催化。

K 的值和选人策略是应用层参数，可迭代。

### 决策 2：触发策略

**选择**: 用户主动触发。

用户提交需求 → 场发现 → 用户看到邻近图 → 用户确认"开始结晶" → 结晶循环。

与 V1 的用户体验连续，降低认知门槛。自动触发是后续迭代方向。

### 决策 3：参与者规模

**选择**: 上限 ~8 人，超出按相关度截断。

圆桌会议有自然的规模上限（7-8 人），超过后催化 Agent 的注意力质量下降。分组策略是后续优化方向。

### 决策 4：方案交付形态

**选择**: 结晶收敛后产出分工方案。

**关键修正**："协议止于可见性"约束的是催化循环过程中催化 Agent 的行为边界，不是协议最终的交付形态。

结晶的交付物是协作构型——谁做什么、谁得到什么、谁付出什么。每个参与者看到的是自己的任务、收益和成本，不是全部会议记录（虽然可查看）。

流程：
```
循环阶段：催化只观察、指出关系、不推荐（保护参与者自主表达）
    ↓ 收敛
方案阶段：基于全部上下文，生成具体分工方案
    ↓
交付：每个参与者看到自己的部分
    ↓ （未来）
链上：构型 → WOWOK Machine JSON 智能合约
```

方案生成 Agent 的 prompt 是应用层的——不同场景换不同 prompt。

### 决策 5：输出格式路径

**选择**: 先自然语言 → 后 JSON → 两种保留。

1. 先用自然语言调通催化循环和收敛机制
2. 加 JSON 输出层对接 WOWOK Machine 智能合约格式
3. 两种格式都保留（JSON 是机器消费的，自然语言是人消费的）

### 决策 6：收敛检测

**选择**: 催化 Agent 连续两轮没有新发现 = 收敛。最大轮次作为硬保障。

系统有自纠正能力：过早收敛 → 残余张力大 → 回到模块一触发新结晶。

### 决策 7：代码保障边界

**选择**: 确定性逻辑用代码保障，理解和判断用 prompt 保障。

- 代码：最大轮次、超时、输入格式校验、越界输出检测
- Prompt：催化行为边界、翻译质量、传输策略
- 模型足够强时，prompt 本身就是保障

### 决策 8：现有代码复用

**选择**: V1 代码只做参考，模块二从零开始写。

V1 五阶段流水线和模块二两步一循环是不同的概念模型。模块一代码（MemoryField）是模块二的上游依赖（消费其输出），但模块二自身代码从零开始。

## 实验策略

### 目标

不是验证"能不能做到"（肯定能做到），是验证"怎么更好做到"。这是 prompt 迭代实验。

### 材料

- 3+ 个高异质性人物，每人几千字深度 Profile
- Profile 社区共建：每个人写自己的真实 profile，不需要懂协议
- 一个具体的触发事件
- 人物之间的关联必须是跨语义空间的

### 评估路径

1. 先人工评估（数量少时），建立 ground truth
2. 沉淀评估原则后，引入 LLM-as-Judge 自动化
3. 用人工评估校准 Judge 的评分标准

### 实验序列

1. 设计端侧 prompt v0 + 催化 prompt v0
2. 用深度 Profile 跑第一轮手工模拟结晶（3 人）
3. 人工评估，识别 prompt 的弱点
4. 迭代 prompt → 重跑 → 评估
5. 稳定后引入 LLM-as-Judge
6. 加 JSON 输出层

## 影响范围

- 新模块：`backend/towow/crystallization/`（待建）
- 设计文档：`docs/design-logs/DESIGN_LOG_006_CRYSTALLIZATION_PROTOCOL.md`
- 旧版设计存档：`docs/archive/DESIGN_LOG_006_CRYSTALLIZATION_PROTOCOL_v1.md`
- 社区任务：Profile 共建（见 `docs/community/profile-contribution-guide.md`）
- 实验代码：`tests/crystallization_poc/`（待建）
